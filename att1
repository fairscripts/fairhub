--========================================================--
-- Monitor de Descendentes no Workspace (ajustado p/ 2 modelos)
--========================================================--
local infoModels = {}   -- armazena modelos de info
local attachModels = {} -- armazena modelos Attach

-- FunÃ§Ã£o para processar um par Info + Attach
local function processarBrainrot(infoModel, attachModel)
    if not infoModel or not infoModel.Parent then return end
    if not attachModel or not attachModel.Parent then return end

    -- Captura Info
    local hrp = infoModel:FindFirstChild("HumanoidRootPart")
    local infoFolder = hrp and hrp:FindFirstChild("Info")
    if not infoFolder then return end

    local displayLabel = infoFolder:FindFirstChild("DisplayName", true)
    local displayText = (displayLabel and displayLabel:IsA("TextLabel")) and displayLabel.Text or "N/A"

    local priceLabel = infoFolder:FindFirstChild("Price", true)
    local priceText = (priceLabel and priceLabel:IsA("TextLabel")) and priceLabel.Text or "0"
    local priceNumber = parseNumberWithSuffix(priceText)

    local genLabel = infoFolder:FindFirstChild("Generation", true)
    local genText = (genLabel and genLabel:IsA("TextLabel")) and genLabel.Text or "N/A"

    local rarityLabel = infoFolder:FindFirstChild("Rarity", true)
    local rarityText = (rarityLabel and rarityLabel:IsA("TextLabel")) and rarityLabel.Text or "N/A"

    print(("[DEBUG] Brainrot detectado | Nome: %s | Price: %s | Gen: %s | Rarity: %s")
        :format(displayText, priceText, genText, rarityText))

    -- Envia msg de spawn
    local msg = string.format(
        "ðŸš¨ Brainrot Spawnado!\nNome: %s\nPrice: %s\nGeneration: %s\nRarity: %s\n",
        displayText, priceText, genText, rarityText
    )
    sendWebhook(msg)

    -- Decide se compra
    if priceNumber > limitePrice then
        print(("[DEBUG] Price acima de %s â€” iniciando follow."):format(limitePrice))

        -- Envia msg de compra
        local msg2 = string.format(
            "ðŸš¨ Brainrot comprado!\nNome: %s\nPrice: %s\nGeneration: %s\nRarity: %s",
            displayText, priceText, genText, rarityText
        )
        sendWebhookR(msg2)

        -- Segue o modelo de info e interage com o Prompt do modelo Attach
        task.spawn(function()
            local prompt = acharPrompt(attachModel)
            seguirEInteragirAteSumir(infoModel, displayText, prompt)
        end)
    else
        print(("[DEBUG] Price abaixo de %s â€” ignorado."):format(limitePrice))
    end
end

--========================================================--
-- Ajuste na funÃ§Ã£o de seguir para usar prompt externo
--========================================================--
function seguirEInteragirAteSumir(model, displayName, promptModel)
    local char, humanoid, hrp = waitForCharacterParts(5)
    if not char or not humanoid or not hrp then return end

    print(("[DEBUG] Iniciando follow no modelo: %s | DisplayName: %s"):format(model.Name, displayName))

    local lastPrint, lastFireTime, tentativas = 0, 0, 0
    local connection
    connection = RunService.Heartbeat:Connect(function()
        if not model or not model.Parent then
            print("[DEBUG] Modelo removido â€” parando follow.")
            connection:Disconnect()
            return
        end

        local targetPart = acharParteAlvo(model)
        if targetPart then
            local dist = (hrp.Position - targetPart.Position).Magnitude
            if tick() - lastPrint > 2 then
                print(("[DEBUG] DistÃ¢ncia do modelo: %.2f studs"):format(dist))
                lastPrint = tick()
            end
            if dist > 2.2 then pcall(function() humanoid:MoveTo(targetPart.Position) end) end
        end

        local prompt = acharPrompt(promptModel)
        if prompt then
            local promptPos
            if prompt.Parent:IsA("BasePart") then
                promptPos = prompt.Parent.Position
            elseif prompt.Parent:IsA("Attachment") and prompt.Parent.Parent:IsA("BasePart") then
                promptPos = prompt.Parent.Parent.Position
            end
            if promptPos and (hrp.Position - promptPos).Magnitude <= 10 then
                if tentativas < 5 and tick() - lastFireTime >= 2 then
                    print(("[DEBUG] Disparando ProximityPrompt (%d/5)"):format(tentativas+1))
                    safeFirePrompt(prompt, 2)
                    tentativas += 1
                    lastFireTime = tick()
                elseif tentativas >= 5 then
                    print("[DEBUG] Limite de tentativas atingido â€” parando follow.")
                    connection:Disconnect()
                end
            end
        else
            print("[DEBUG] ProximityPrompt sumiu â€” parando follow.")
            connection:Disconnect()
        end
    end)
end

--========================================================--
-- Detectar novos modelos
--========================================================--
workspace.ChildAdded:Connect(function(obj)
    task.wait(0.3)

    if obj:IsA("Model") then
        if obj:FindFirstChild("HumanoidRootPart") then
            -- Esse Ã© o modelo de Info
            print("[DEBUG] Modelo de INFO detectado:", obj.Name)
            infoModels[obj] = true
            -- Tenta achar um Attach disponÃ­vel
            for att,_ in pairs(attachModels) do
                processarBrainrot(obj, att)
                attachModels[att] = nil
                infoModels[obj] = nil
                break
            end

        elseif obj.Name:lower():find("attach") then
            -- Esse Ã© o modelo Attach
            print("[DEBUG] Modelo ATTACH detectado:", obj.Name)
            attachModels[obj] = true
            -- Tenta achar um Info disponÃ­vel
            for inf,_ in pairs(infoModels) do
                processarBrainrot(inf, obj)
                infoModels[inf] = nil
                attachModels[obj] = nil
                break
            end
        end
    end
end)

print("[Script] Pronto â€” agora monitora Info + Attach e junta os dois para interagir.")
